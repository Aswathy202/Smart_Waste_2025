{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4 fw-bold text-success">Collector Dashboard</h2>

    <!-- Statistics Cards -->
    <div class="row text-center mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6>Total</h6>
                    <h3><i class="bi bi-list-ul"></i> {{ summary.total }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6>Pending</h6>
                    <h3 class="text-warning"><i class="bi bi-hourglass-split"></i> {{ summary.pending }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6>Collected</h6>
                    <h3 class="text-primary"><i class="bi bi-truck"></i> {{ summary.collected }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6>Recycled</h6>
                    <h3 class="text-success"><i class="bi bi-recycle"></i> {{ summary.recycled }}</h3>
                </div>
            </div>
        </div>
    </div>
    <a href="{% url 'collector_complaints' %}" class="btn btn-outline-success mb-2">
  View Complaints
</a>

   

    <!-- Assigned Requests Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="fw-bold mb-3"><i class="bi bi-table text-success"></i> Assigned Waste Pickup Requests</h5>
            <table class="table table-striped table-hover">
                <thead class="table-success">
                    <tr>
                        <th>ID</th>
                        <th>Citizen</th>
                        <th>Waste Type</th>
                        <th>Quantity</th>
                        <th>Location</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in assigned_requests %}
                    <tr>
                        <td>{{ req.id }}</td>
                        <td>{{ req.user.username }}</td>
                        <td>{{ req.waste_type }}</td>
                        <td>{{ req.quantity }}</td>
                        <td>{{ req.location }}</td>
                        <td>
    <form method="post" action="{% url 'update_request_status' req.id %}">
        {% csrf_token %}
        <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="Pending" {% if req.status == 'Pending' %}selected{% endif %}>Pending</option>
            <option value="Collected" {% if req.status == 'Collected' %}selected{% endif %}>Collected</option>
            <option value="Recycled" {% if req.status == 'Recycled' %}selected{% endif %}>Recycled</option>
        </select>
        <button type="submit" class="btn btn-success btn-sm">Update</button>
    </form>
</td>

                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">No assigned requests yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
 <!-- Map Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="fw-bold mb-3"><i class="bi bi-geo-alt-fill text-success"></i> Pickup Locations Map</h5>
            <div id="map" style="height: 400px; border-radius: 12px;"></div>
        </div>
    </div>
<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const map = L.map("map").setView([9.5916, 76.5222], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "Â© OpenStreetMap contributors",
    }).addTo(map);

    const mapData = {{ map_data|safe }};

    if (mapData.length === 0) {
        L.popup()
            .setLatLng([9.5916, 76.5222])
            .setContent("<b>No pickup requests assigned yet.</b>")
            .openOn(map);
        return;
    }

    mapData.forEach((point) => {
        let markerColor;

        switch (point.status) {
            case "Pending":
                markerColor = "red";
                break;
            case "Collected":
                markerColor = "green";
                break;
            case "Recycled":
                markerColor = "blue";
                break;
            default:
                markerColor = "gray";
        }

        const icon = L.divIcon({
            className: "custom-icon",
            html: `<div style="background-color:${markerColor}; width:12px; height:12px; border-radius:50%; border:2px solid white;"></div>`,
        });

        L.marker([point.latitude, point.longitude], { icon })
            .addTo(map)
            .bindPopup(`
                <b>${point.citizen}</b><br>
                <b>Waste:</b> ${point.waste_type}<br>
                <b>Status:</b> ${point.status}<br>
                <small>${point.location}</small>
            `);
    });

    const bounds = L.latLngBounds(mapData.map(p => [p.latitude, p.longitude]));
    map.fitBounds(bounds);
});
</script>
{% endblock %}
